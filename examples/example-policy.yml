# example-policy.yml
#
# Example security policy configuration for mcp-ssh-orchestrator.
# Copy this to config/policy.yml and customize for your security requirements.
#
# This file defines:
#   - Command allow/deny rules with glob patterns (deny-by-default)
#   - Execution limits (timeouts, output caps, async TTLs)
#   - Network controls (IP allowlists/blocklists)
#   - Per-host and per-tag overrides
#
# IMPORTANT:
#   - Host key verification is always enforced. `host_key_auto_add: true` and
#     `require_known_host: false` are deprecated and ignored for security (CWE-295).
#   - Maintain a known_hosts file and mount it read-only into /app/keys.

# Strict host-key validation file (mount read-only)
known_hosts_path: "/app/keys/known_hosts"

# Global execution limits (overrides can change these per alias/tag)
limits:
  max_seconds: 60
  max_output_bytes: 1048576
  host_key_auto_add: false            # kept for backwards compatibility (ignored)
  require_known_host: true            # keep this enabled to enforce strict host key verification
  task_result_ttl: 300                # seconds; async results retained for 5 minutes
  task_progress_interval: 5           # seconds between progress notifications

  # Hard-blocked command substrings (checked before rule evaluation)
  deny_substrings:
    # Destructive commands
    - "rm -rf /"
    - ":(){ :|:& };:"
    - "mkfs "
    - "dd if=/dev/zero"
    - "shutdown -h"
    - "reboot"
    - "userdel "
    - "passwd "
    # Lateral movement / egress tools
    - "ssh "
    - "scp "
    - "rsync -e ssh"
    - "curl "
    - "wget "
    - "nc "
    - "nmap "
    - "telnet "
    - "kubectl "
    - "aws "
    - "gcloud "
    - "az "

# Network egress controls
network:
  # Allow only RFC1918 ranges by default (empty list = allow all)
  allow_ips: []
  allow_cidrs:
    - "10.0.0.0/8"
    - "172.16.0.0/12"
    - "192.168.0.0/16"

  # Explicit denies win over allows
  block_ips: []
  block_cidrs: []

  # Require known_hosts entry before connection (enforced in code)
  require_known_host: true

# Command allow/deny rules (deny-by-default)
rules:
  # Safe read-only commands on all hosts
  - action: "allow"
    aliases: ["*"]
    tags: []
    commands:
      - "uname*"
      - "uptime*"
      - "whoami"
      - "df -h*"
      - "free -m*"
      - "cat /etc/os-release*"
      - "ls*"
      - "echo*"
      - "id*"
      - "hostname*"
      - "date*"

  # Package inventory on Linux hosts
  - action: "allow"
    aliases: ["*"]
    tags: ["linux"]
    commands:
      - "dpkg -l*"
      - "rpm -qa*"
      - "apt list --installed*"

  # Service status checks (read-only)
  - action: "allow"
    aliases: ["*"]
    tags: []
    commands:
      - "systemctl status *"
      - "journalctl --no-pager -n 200 *"
      - "docker ps*"
      - "docker inspect*"

  # Network diagnostics on non-production environments
  - action: "allow"
    aliases:
      - "stg-*"
      - "lab-*"
      - "dev-*"
    tags:
      - "staging"
      - "lab"
      - "dev"
    commands:
      - "ping*"
      - "traceroute*"
      - "ss -tulpn*"
      - "netstat*"

  # Controlled service restarts on staging only
  - action: "allow"
    aliases: ["stg-*"]
    tags: ["staging"]
    commands:
      - "sudo systemctl restart *"
      - "sudo systemctl start *"
      - "sudo systemctl stop *"

  # Explicit denies (for clarity, redundant with deny_substrings)
  - action: "deny"
    aliases: ["*"]
    tags: []
    commands:
      - "rm *"
      - "chmod 777*"
      - "chown -R *"
      - "shutdown*"
      - "reboot*"

# Per-alias and per-tag limit overrides
overrides:
  aliases:
    # Production hosts: tighter timeouts/output limits
    prod-web-1:
      max_seconds: 30
      max_output_bytes: 524288
    prod-db-1:
      max_seconds: 20
      max_output_bytes: 262144

  tags:
    # Production: apply stricter defaults automatically
    production:
      max_seconds: 30
      max_output_bytes: 524288

    # Lab: relaxed timeout for experimentation (host key rules still enforced)
    lab:
      max_seconds: 90

    # Long-running operations: extend async result TTL for post-run inspection
    longrun:
      max_seconds: 180
      task_result_ttl: 1800   # 30 minutes
