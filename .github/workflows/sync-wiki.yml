name: Sync Wiki Documentation

on:
  push:
    branches: [main]
    paths:
      - 'docs/wiki/**'
      - '.github/workflows/sync-wiki.yml'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Create Wiki Sync Script
        run: |
          cat > sync-wiki.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "üîÑ Starting wiki sync process..."
          
          # Create wiki directory
          mkdir -p wiki-sync
          cd wiki-sync
          
          # Initialize git repo for wiki
          git init
          git remote add origin https://github.com/${{ github.repository }}.wiki.git
          
          # Try to fetch existing wiki content
          echo "üì• Fetching existing wiki content..."
          if git fetch origin master 2>/dev/null; then
            echo "‚úÖ Found existing wiki, checking out master branch"
            git checkout -b master origin/master
          else
            echo "‚ÑπÔ∏è No existing wiki found, creating new master branch"
            git checkout -b master
          fi
          
          # Copy wiki content
          echo "üìã Copying wiki content..."
          rsync -av --delete ../docs/wiki/ ./
          
          # Add .gitkeep to preserve empty directories
          find . -type d -empty -exec touch {}/.gitkeep \;
          
          # Check for changes
          git add .
          
          if ! git diff --staged --quiet; then
            echo "üìù Changes detected, committing..."
            
            # Get list of changed files
            CHANGED_FILES=$(git diff --staged --name-only | head -10)
            
            git commit -m "Sync wiki from main repository

          Updated from commit: ${{ github.sha }}
          Triggered by: ${{ github.event.head_commit.message }}
          
          Changed files:
          $CHANGED_FILES
          
          [skip ci]"
            
            # Push to wiki repository
            echo "üöÄ Pushing to wiki repository..."
            if git push origin master; then
              echo "‚úÖ Wiki synced successfully"
            else
              echo "‚ùå Failed to push to wiki repository"
              echo "This might be due to:"
              echo "1. Wiki repository not existing yet"
              echo "2. Insufficient permissions"
              echo "3. Network issues"
              echo ""
              echo "To fix this:"
              echo "1. Go to your repository settings"
              echo "2. Enable the Wiki feature"
              echo "3. Create at least one wiki page manually"
              echo "4. Re-run this workflow"
              exit 1
            fi
          else
            echo "‚ÑπÔ∏è No changes to sync"
          fi
          
          echo "üéâ Wiki sync process completed"
          EOF
          
          chmod +x sync-wiki.sh
      
      - name: Run Wiki Sync
        run: ./sync-wiki.sh
      
      - name: Validate Wiki Content
        run: |
          echo "üîç Validating wiki content..."
          
          # Check if wiki directory exists and has content
          if [ -d "wiki-sync" ] && [ "$(ls -A wiki-sync)" ]; then
            echo "‚úÖ Wiki content directory exists and has content"
            
            # Count markdown files
            MD_COUNT=$(find wiki-sync -name "*.md" | wc -l)
            echo "üìÑ Found $MD_COUNT markdown files"
            
            # List main files
            echo "üìã Main wiki files:"
            find wiki-sync -name "*.md" -not -path "*/assets/*" | head -10 | while read file; do
              echo "  - $(basename "$file")"
            done
            
            # Check for required files
            if [ -f "wiki-sync/_Sidebar.md" ]; then
              echo "‚úÖ _Sidebar.md found"
            else
              echo "‚ö†Ô∏è _Sidebar.md not found"
            fi
            
            if [ -f "wiki-sync/Home.md" ]; then
              echo "‚úÖ Home.md found"
            else
              echo "‚ö†Ô∏è Home.md not found"
            fi
            
          else
            echo "‚ùå Wiki content directory is empty or doesn't exist"
            exit 1
          fi

  validate-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install validation tools
        run: |
          # Install basic tools
          pip install pyyaml
          
          # Install markdown link checker if available
          npm install -g markdown-link-check || echo "markdown-link-check not available"
      
      - name: Validate YAML examples
        run: |
          echo "üîç Validating YAML examples in documentation..."
          
          # Find all markdown files with YAML examples
          find docs/wiki -name "*.md" -exec grep -l "```yaml" {} \; | while read file; do
            echo "Validating YAML in: $file"
            
            # Extract YAML blocks and validate them
            python3 << 'EOF'
          import yaml
          import sys
          import re
          
          def extract_yaml_blocks(content):
              """Extract YAML blocks from markdown content."""
              pattern = r'```yaml\n(.*?)\n```'
              matches = re.findall(pattern, content, re.DOTALL)
              return matches
          
          def validate_yaml(yaml_content):
              """Validate YAML content."""
              try:
                  yaml.safe_load(yaml_content)
                  return True, None
              except yaml.YAMLError as e:
                  return False, str(e)
          
          # Read the file
          with open(sys.argv[1], 'r') as f:
              content = f.read()
          
          # Extract YAML blocks
          yaml_blocks = extract_yaml_blocks(content)
          
          if not yaml_blocks:
              print("  ‚ÑπÔ∏è No YAML blocks found")
              return
          
          # Validate each YAML block
          for i, yaml_block in enumerate(yaml_blocks):
              is_valid, error = validate_yaml(yaml_block)
              if is_valid:
                  print(f"  ‚úÖ YAML block {i+1} is valid")
              else:
                  print(f"  ‚ùå YAML block {i+1} is invalid: {error}")
                  sys.exit(1)
          
          print(f"  ‚úÖ All {len(yaml_blocks)} YAML blocks are valid")
          EOF
          "$file" || echo "‚ö†Ô∏è YAML validation failed for $file"
          done
      
      - name: Check documentation structure
        run: |
          echo "üìä Documentation structure analysis:"
          
          # Count files by type
          echo "üìÑ Markdown files: $(find docs/wiki -name "*.md" | wc -l)"
          echo "üé® Mermaid files: $(find docs/wiki -name "*.mmd" | wc -l)"
          echo "üìÅ Total size: $(du -sh docs/wiki | cut -f1)"
          
          # Check for required sections
          required_sections=(
            "01-MCP-Overview.md"
            "02-Risks.md"
            "03-Design-Goals.md"
            "04-Architecture.md"
            "05-Security-Model.md"
            "06-Configuration.md"
            "07-Tools-Reference.md"
            "08-Usage-Cookbook.md"
            "09-Deployment.md"
            "10-Integrations.md"
            "11-Observability-Audit.md"
            "12-Troubleshooting.md"
            "13-Contributing.md"
            "14-Roadmap.md"
            "15-FAQ.md"
            "16-Glossary.md"
          )
          
          echo "üîç Checking required sections:"
          missing_sections=()
          for section in "${required_sections[@]}"; do
            if [ -f "docs/wiki/$section" ]; then
              echo "  ‚úÖ $section"
            else
              echo "  ‚ùå $section"
              missing_sections+=("$section")
            fi
          done
          
          if [ ${#missing_sections[@]} -gt 0 ]; then
            echo "‚ùå Missing sections: ${missing_sections[*]}"
            exit 1
          else
            echo "‚úÖ All required sections present"
          fi